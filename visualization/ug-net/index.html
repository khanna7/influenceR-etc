<!DOCTYPE html>
<meta charset="utf-8">
<style>

canvas {
  border: dotted;
}

</style>
<body>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="graphCanvas.js"></script>
<script>

var width = window.innerWidth,
    height = window.innerHeight;

d3.text("ug-net.dim", "text/plain", function(data) {
  
  var numedges = +getParameterByName("numedges") || -1;
  var graph = dim2graph(data, numedges);
  
  
  d3.csv("serodiscordance.data.csv", function(edges_infected) {
    var limit = numedges == -1 ? edges_infected.length : numedges;
    for (var i = 0; i < limit; i++) {
      var d = edges_infected[i];
      var edge = graph.edges[i];
      if (d["sdp.indicator"] == "1") {
        edge.color = "red";
        edge.arrow = 1;
        if(d["inf.member"] == "Source")
          edge.direction = 1;
        else if(d["inf.member"] == "Target")
          edge.direction = 2;
      }
    }
  });
  
    
  var graph_canvas = graphCanvas()
    .nodes(graph.nodes)
    .edges(graph.edges);
  
  d3.select("body")
    .append("div")
    .style("width", "1000px")
    .style("height", "1000px")
    .call(graph_canvas);
  
  graph_canvas.start();
  
});

function dim2graph(text, numedges) {
  var nodes = [], edges = [], nodesByIndex = {}
  
  function idx2node(i, col) {
    
    if (nodesByIndex[i] == undefined) {
      var node = {"index": i, "color": col, outlinks: []}
      nodesByIndex[i] = node;
      nodes.push(node)
      return node;
    }
    else
      return nodesByIndex[i];
  }
  
  text.split('\n').forEach(function(line, i) {
    if (numedges != -1 && i > numedges)
      return;
    var tokens = line.split(' ')
    if (tokens[0] != "e")
      return;
    var isrc = tokens[1].trim(), itar = tokens[2].trim();
    var src = idx2node(isrc, "orange"), tar = idx2node(itar, "purple");
    edges.push({source: src, target: tar});
  });
  
  return {nodes: nodes, edges: edges, nodesByIndex: nodesByIndex}
    
}

function getParameterByName(name) {
    name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
    var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
        results = regex.exec(location.search);
    return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
}
</script>
