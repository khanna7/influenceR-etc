<!DOCTYPE html>
<meta charset="utf-8">
<style>

.node {
  stroke: #fff;
  stroke-width: 1.5px;
}

.link {
  stroke: #999;
  stroke-opacity: .6;
}

.highlight {
  fill: red;
}

.selected {
  fill: green;
}

a {
    color: gray;
}

body {
    font-family: Arial;
    background: none repeat scroll 0% 0% #F2F2F2;
	margin-left: 10%;
	margin-right: 10%;
}

h1 {
	color: maroon;
}

h2 {
	color: gray;
}

</style>
<body>

<h1>Finding the Key Players in a Graph</h1>
<h2>Powered by <a href="http://rcc.uchicago.edu">RCC</a></h2>

<div id="selection">
</div>

<div id="menu">
    Key Players:
    <input type="number" id="kpk" style="width:50px" min="1" max="100"></input><button id="gokp">Go!</button><br>
    Found KP-sets:
    <ul id="kpsets"></ul>
</div>

<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="matrix.js"></script>
<script src="keyplayer.js"></script>
<script>

var width = 960,
    height = 500;

var color = d3.scale.category20();

var force = d3.layout.force()
    .charge(-120)
    .linkDistance(30)
    .size([width, height]);

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);


d3.json("miserables.json", function(error, graph) {
  
  var keyPlayer = newKP()
      .nodes(graph.nodes)
      .links(graph.links);
  keyPlayer.distanceMatrix(); // gotta do this before we start force layout


  force
      .nodes(graph.nodes)
      .links(graph.links)
      .start();

  var link = svg.selectAll(".link")
      .data(graph.links)
    .enter().append("line")
      .attr("class", "link")
      .style("stroke-width", function(d) { return Math.sqrt(d.value); });

  var node = svg.selectAll(".node")
      .data(graph.nodes)
    .enter().append("circle")
      .attr("class", "node")
      .attr("r", 5)
      .call(force.drag);

  node.append("title")
      .text(function(d) { return d.name; });

  /* Selection feature */
  var selectedNodesByNumber = {},
      metric = keyPlayer.metric();
  node.on("click", function(d, i) {
    var that = d3.select(this),
      selected = selectedNodesByNumber[i];
    if (selected) {
      that.classed("selected", false);
      delete (selectedNodesByNumber[i]);
    }
    else { 
      that.classed("selected", true);
      selectedNodesByNumber[i] = d;
    }

    var nodes = d3.keys(selectedNodesByNumber).map(function(x) { return parseInt(x); }), // appears sorted by string, which is good enough
        names = d3.values(selectedNodesByNumber).map(function(d) { return d.name; }),
        fit = metric(nodes);
     d3.select("#selection")
      .html("Selected: <a href='#'>" + JSON.stringify(names) + "</a> (" + fit + ")")
      .select("a")
      .datum(nodes)
      .on("click", runKeyPlayer);
  });

  /* Force layout */
  force.on("tick", function() {
    link.attr("x1", function(d) { return d.source.x; })
        .attr("y1", function(d) { return d.source.y; })
        .attr("x2", function(d) { return d.target.x; })
        .attr("y2", function(d) { return d.target.y; });

    node.attr("cx", function(d) { return d.x; })
        .attr("cy", function(d) { return d.y; });
  });

  var kpsets = d3.select("#kpsets");
 
  d3.select("#gokp").on("click", function() {
    
    var k = d3.select("#kpk").node().value;
    keyPlayer.k(k);
    runKeyPlayer();

  });

  function runKeyPlayer(s) {
      var kset = keyPlayer(s);
      highlightSet(kset.nodes);
      kpsets.append("li")
        .datum(kset.nodes)
        .html("<a href='#'>" + JSON.stringify(kset.nodes.map(function(d) { return d.name })) + "</a> (" + kset.fit + ")")
        .select("a")
        .on("mouseover", highlightSet);
  }

  function highlightSet(kpset) {
    graph.nodes.forEach(function(d) {
      d.group = 0;
    });
    kpset.forEach(function(d) {
      d.group = 1;
    });
    node.classed("highlight", function(d) { return d.group; });
    /* remove selection from nodes we just highlighted... ugh */
    node.each(function(d) {
      if(d.group == 1)
        d3.select(this).classed("selected", false);
    });
  }


});
</script>

<div id="readme">
<p>This example shows a D3 implementation of the Key Players algorithm, as laid out in <a href="http://www.bebr.ufl.edu/sites/default/files/Borgatti%20-%202006%20-%20Identifying%20sets%20of%20key%20players%20in%20a%20social%20networ.pdf">Borghatti 2006</a>. We focus on KP-Pos - finding a set of size <em>k</em> that is maximally connected to the other nodes in the graph. We use the greedy optimization algorithm outlined in the paper, and equation (14) as our metric.</p>

<p>Usage: Set a number of key players to find and press "Go!". This will generate a random starting set of size <em>k</em> and then run the optimization algorithm. Alternatively, click nodes to select them, allowing you to view their fit with the KP metric. Then, click the list of selected nodes to run Key Player with your selected nodes as the starting set. Compare sets in the "Found KP-sets" list by hovering over the grey links.</p>

<p>The force-layout was adapted from Mike Bostock's force-directed graph <a href="http://bl.ocks.org/mbostock/4062045">example</a>. As in that example, the data is 'based on character coappearence in Victor Hugo's <em>Les Misérables</em>, compiled by <a href="http://www-cs-faculty.stanford.edu/~uno/sgb.html">Donald Knuth</a>.' It looks like this graph has unique local minima that the optimization algorithm finds every time. This is actually a little disappointing, at least for demonstration purposes: the algorithm starts with a random guess, and iteratively improves it. We'd like to be able to see and compare different subsets gotten from different starting guesses, but our <em>Les Misérables</em> characters are too well-behaved!</p>

<p><a href='keyplayer.js'>keyplayer.js</a> contains the Key Player implementation. It relies on <a href='matrix.js'>matrix.js</a>, a extremely tiny JS library I wrote for this example, to allow some higher-level slicing and indexing than provided by Javascript arrays. In my informal, qualitative assessment, it was faster than <a href="http://mathjs.org/docs/datatypes/matrices.html">math.js</a> or <a href="http://sylvester.jcoglan.com/">Sylvester</a> (my script did not finish executing when I used those libraries). But my library has pretty much NO features besides matrix creation, indexing, and slicing.</p>
</div>