<!DOCTYPE html>
<meta charset="utf-8">
<style>

.node circle {
  fill: #fff;
  stroke: black;
  stroke-width: 1.5px;
}

.node {
  font: 10px sans-serif;
}

.link {
  fill: none;
  stroke: #ccc;
  stroke-width: 1.5px;
}

.root circle {
  fill: #9467bd;
  stroke: black;
  stroke-width: 1.5px;
}

.header circle {
  stroke: black;
  stroke-width: 1.5px;
}

.root {
  font: 12px sans-serif;
}

div.footer {
  position: fixed;
  right: 50px;
  bottom: 20px;
  visibility: hidden;
}

div.footer a {
  color: grey;
}

.header {
  position: absolute;
  margin: 1%;
  font: 18px sans-serif;
  border: dashed;
  padding: 1%;
  z-index: 1;
}
</style>
<body>
  
  <div class="header">
    <div>PrEP Aware</div><br>
  </div>
  
  <div class="footer">
  Powered by <a href="http://rcc.uchicago.edu">RCC</a>
  </div>
  
<script src="http://d3js.org/d3.v3.min.js"></script>
<script>

/* legend */
var legend = d3.select(".header")
var points = d3.entries({"Yes": "#1f77b4", "No": "#ff7f0e", "No report": "#2ca02c"})
points.forEach(function(d) {
  var p = legend.append("div")
  p.append("svg")
    .attr({width: 18, height:18})
    .append("circle")
    .attr({r: 6, cx: 9, cy: 9})
    .style("fill", d.value)
  p.append("span").text("     " + d.key)
})
var drag = d3.behavior.drag()
  .on("drag", function(d) {
    d.x += d3.event.dx
    d.y += d3.event.dy
    this.style.left = d.x+'px'
    this.style.top = d.y+'px'
  });
legend.datum({x:0, y:0}).call(drag)

var diameter = 2*window.innerWidth + 240;

var tree = d3.layout.tree()
    .size([window.innerHeight, window.innerWidth])
    .separation(function(a, b) { return 5*(a.parent == b.parent ? 1 : 2) / a.depth; });

var diagonal = d3.svg.diagonal.radial()
    .projection(function(d) { return [d.y, d.x / 180 * Math.PI]; });


/* draggable container for svg */
var content = d3.select("body")
    .append("div")
    .style("position", "absolute")
    .datum({x:0, y:0}).call(drag)

var svg = content.append("svg")
    .attr("width", diameter)
    .attr("height", diameter - 150)
  .append("g")
    .attr("transform", "translate(" + 0.15*diameter + "," + 0.15*diameter + "),scale(0.3)");


d3.csv("ego.csv", function(error, graph) {
  
  var h = graphHierarchy(graph)
  
  var nodes = tree.nodes(h),
      links = tree.links(nodes);

  var link = svg.selectAll("path.link")
      .data(links)
    .enter().append("path")
      .attr("class", "link")
      .attr("d", diagonal);


  /* Root */
  var root = svg.append("g")
      .attr("class", "root")
      .attr("transform", "translate(" + nodes[0].y + ")")
  root.append("circle")
      .attr("r", 50)
      /*
  root.append("text")
      .attr("dy", ".31em")
      //.attr("text-anchor", function(d) { return d.x < 180 ? "start" : "end"; })
      .attr("transform", "translate(-20)")
      .text(nodes[0].name);
*/

  /* All children */
  var node = svg.selectAll("g.node")
      .data(nodes.slice(1))
    .enter().append("g")
      .attr("class", "node")
      .attr("transform", function(d) { return "rotate(" + (d.x - 90) + ")translate(" + d.y + ")"; })

  node.append("circle")
      //.attr("r", function(d) { return d.parent.parent ? 20 : 20 });
    .attr("r", 30);

    /*
  node.append("text")
      .attr("dy", ".31em")
      .attr("text-anchor", function(d) { return d.x < 180 ? "start" : "end"; })
      .attr("transform", function(d) { return d.x < 180 ? "translate(8)" : "rotate(180)translate(-8)"; })
      .text(function(d) { return d.name; });  
    */

  d3.csv("prepknow_data.csv", function(error, data) {
  
    var colorById = {},
    color = d3.scale.category10()
  
    data.forEach(function(row) {
      colorById[row["V1"]] = row["V2"]
    })
    
    node.selectAll("circle")
      .style("fill", function(d) { 
        var c = colorById[d.name];
        if (!c) return  "#2ca02c";
        return color(c);
      });
  
  });

});


d3.select(self.frameElement).style("height", diameter - 150 + "px");

function graphHierarchy(edges) {
  var nodesById = []
  var nodes = []
  
  function idToNode(id) {
    if (nodesById[id])
      return nodesById[id]
    var node = {"name": id, "children": []}
    nodes.push(node)
    nodesById[id] = node;
    return node
  }
  
  edges.forEach(function(d) {
    var src = idToNode(d.source)
    var tar = idToNode(d.target)
    src.children.push(tar)
    tar.parent = src
  })
  
  var maxsz = 0;
  var maxtree;
  var trees = []
  nodes.forEach(function(d) {
    if (!d.parent)
      trees.push(d)
    d.size = calcSize(d);
    if (d.size > maxsz) {
      maxsz = d.size
      maxtree = d
    }
  })

  function calcSize(tree) {
    if (!tree.children)
      return 1;
    var size = 1;
    tree.children.forEach(function(d) {
      size += calcSize(d)
    });
    return size;
  }
  
  var root = {"name": "Seeds", "children": trees}
  return root
}


svg.on("dblclick", downloadSVG);

function svgToText(svg) {
    var text = '<svg width="' + svg.attr("width") + '" height="' + svg.attr("height") + '">'
        + '<style type="text/css" >'
        + '<![CDATA['
        + d3.select("style").html()
        + ']]>'
        + '</style>'
        + svg.html()
        + '</svg>'
    return encodeURIComponent(text);
}

function downloadSVG() {
  var svg = d3.select(this)
  var href = 'data:text/please-download-me;charset=utf-8,' + svgToText(svg);
  var pom = d3.select("body").append("a");
  pom.attr('download', 'image.svg');
  pom.attr('href', 'data:text/plain;charset=utf-8,' + svgToText(svg));
  pom.node().click();
  pom.remove();
}




</script>
